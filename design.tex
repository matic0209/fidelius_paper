
\section{Design}\label{sec:design}

\subsection{Overview}
This section provides a brief overview of the enclaves and notations used in Fidelius, along with its architecture and workflow.

\input{figures/framework}
\subsubsection{Enclaves and Notations}
Throughout this paper, we define the following enclaves and notations:
\begin{itemize}
    \item EKeyMgr. Enclave Key Manager manages asymmetric keys, handling creation, deletion and provides fundamental cryptographic functions, including message encryption, decryption, signing, and signature verification.
    \item EAnalyzer. Enclave Analyzer, an analysis program in Intel SGX Enclave format, ensures the program remains unaltered during execution.
    \item $(PK_{DP},SK_{DP})$, an asymmetric key pair of data provider.
    \item $(PK_{DU},SK_{DU})$, an asymmetric key pair of data user.
    \item $(PK_{CSP}, SK_{CSP})$ represents the asymmetric key pair of cloud service provider, generated by EKeyMgr. The private key, $SK_{CSP}$, is securely stored within the enclave, ensuring that it cannot be extracted by the cloud service provider.
    \item $H(\cdot)$ denotes the hash function.
    \item $Enc(PK, msg)$ denotes the encryption of $msg$ using $PK$.
    \item $Dec(SK, cipher)$ denotes the decryption of $cipher$ using $SK$.
    \item $Sign(SK, msg)$ denotes the signing of $msg$ with $SK$.
    \item $Verf(PK, msg, sig)$ denotes the verification of $sig$ using $PK$ and $msg$.
    \item $\digamma(SK, PK_{CSP}, H_{EA})$ represents the process of forwarding $SK$ to EKeyMgr using $PK_{CSP}$. Within this context, $SK$ is utilized in EAnalyzer, identified by $H_{EA}$. The function $\digamma(\cdot)$ involves $Sign(SK, concat(PK_{CSP}, H_{EA}))$ and $Enc(PK_{CSP}, SK)$.
\end{itemize}

\subsubsection{Architecture and Workflow}

The Fidelius architecture and data analysis workflow are illustrated in Figure~\ref{fig:arch}. 
The process begins with a setup phase where the EKeyMgr in CSP generates an asymmetric key pair. The public key, $PK_{CSP}$, undergoes verification via Intel's remote attestation service, while the private key, $SK_{CSP}$, remains securely stored within EKeyMgr. Concurrently, the Data Provider (DP) and Data User (DU) each generate their own asymmetric key pairs, which they retain. Additionally, the DP encrypts data using her public key, $PK_{DP}$, and prepares this encrypted data for the DU's use.

The DP uploads encrypted data to the CSP and forwards her private key, $SK_{DP}$, to EKeyMgr using $\digamma(SK_{DP}, PK_{CSP}, H_{EA})$. Similarly, the DU uploads the analysis program to the CSP and forwards her private key, $SK_{DU}$, to EKeyMgr using the same method. It is important to note that the plaintext private keys ($SK_{DP}$ and $SK_{DU}$) can only be decrypted within EKeyMgr.

Once the analysis program, encrypted data, and private key are prepared, the data analysis task begins. The analysis program is first checked against the rules defined by the Privacy Description Language (PDL). Any program that fails this check results in an immediate termination of the analysis task. Subsequently, EAnalyzer loads and decrypts the encrypted data. It then verifies the hash of the decrypted data; if it does not match the claimed hash, EAnalyzer halts immediately to prevent processing altered or fraudulent data. If the data is verified, EAnalyzer proceeds with the main analysis, ultimately producing an encrypted result using $PK_{DU}$. Additionally, the result is signed using $SK_{DU}$. Since $SK_{DU}$ resides within EKeyMgr, EAnalyzer establishes a secure channel via local attestation to request $SK_{DU}$.

\input{figures/pdl}
\subsection{Privacy Description Language}
% 为了防止数据分析结果泄漏数据，我们提出了隐私描述语言来定义使用数据的规则，并通过了静态⼆进制分析的⽅法检查分析程序是否遵守隐私描述语言定义的规则。如图所示，这段代码使用PDL描述了在Iris数据集上使用Kmeans算法的规则，这段代码也将被转换成LLVM的中间表示，然后使用符号执行得到PDL描述的规则的状态a。另一方面，我们使用GTIRB作为分析的中间表⽰，在将分析程序转换为中间表⽰后，使⽤符号执⾏获取每个输出变量的状态b，并判断是否满足b包含于a。
To prevent data leakage from analysis results, we have developed a Privacy Description Language (PDL) that defines rules for data usage. Static binary analysis is used to ensure that the analysis program adheres to these PDL-defined rules. As illustrated in Figure~\ref{fig:pdl}, the code snippet uses PDL to specify the rules for applying the KMeans algorithm on the Iris dataset. This code is then translated into LLVM's intermediate representation (IR), followed by symbolic execution~\cite{king1976symbolic,baldoni2018survey} to derive the state $S$ as described by PDL. Concurrently, we utilize GTIRB~\cite{schulte2019gtirb} for intermediate representation in our analysis. After converting the analysis program to this format, symbolic execution is applied to obtain the state $S^{\prime}$ of each output variable, ensuring that $S^{\prime}$ is a subset of $S$, thereby confirming compliance.

\subsection{Trustworthy and Verifiable Results}
Algorithm~\ref{algo:analysis_enclave} outlines the primary operations of EKeyMgr and EAnalyzer. The encrypted analysis result and its signature, generated within EAnalyzer, are transmitted to the blockchain. There, anyone can verify the signature's validity. A valid signature confirms that the DP successfully executed the analysis program and achieved the correct result, since the signature originates from within EAnalyzer. This mechanism prevents attackers from forging a valid signature without executing the analysis program, thereby ensuring the integrity of the data analysis process. The DU can download the encrypted result from the blockchain and decrypt it using $SK_{DU}$ to obtain the plaintext analysis result.
\input{figures/algo_EAnalyzer}

\subsection{One-time Remote Attestation}
%We implement a one-time remote attestation as outlined in Algorithm~\ref{algo:attestation}. 
We incorporate a one-time remote attestation process, as detailed in Algorithm \ref{algo:attestation}, to establish a secure and trusted environment from the outset. 
%During the setup phase, the Cloud Service Provider (CSP) verifies the authorization of $PK_{CSP}$, generated by EKeyMgr, through a remote attestation with Intel service. 
During the setup phase, the Cloud Service Provider (CSP) validates the authorization of the public key $PK_{CSP}$ generated by EKeyMgr by performing a remote attestation with Intel’s attestation service. This thorough verification confirms both the integrity and legitimacy of the CSP’s credentials.
Once verified, subsequent analysis tasks on the CSP no longer require remote attestation. The private keys ($SK$) forwarded by the DP and DU are securely transmitted from EKeyMgr to EAnalyzer via local attestation.
%We incorporate a one-time remote attestation process, as detailed in Algorithm \ref{algo:attestation}, to establish a secure and trusted environment from the outset. During the initial setup phase, the Cloud Service Provider (CSP) rigorously validates the authorization of the public key $PK_{CSP}$ generated by EKeyMgr by performing a remote attestation with Intel’s attestation service. This thorough verification confirms both the integrity and legitimacy of the CSP’s credentials. Once this attestation is successfully completed, all subsequent analysis tasks on the CSP can be executed without further attestation, thereby streamlining operations and reducing overhead. Additionally, the private keys ($SK$) supplied by the DP and DU are securely transmitted from EKeyMgr to EAnalyzer via a robust local attestation process, ensuring that sensitive cryptographic material remains confidential and tamper-resistant throughout the transfer.
